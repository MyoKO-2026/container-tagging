name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main        # Production (CalVer)
      - staging     # Staging (staging-SHA)
      - develop     # Development (develop-SHA)

env:
  MS_NAME: ${{ vars.MS_NAME }}
  GITOPS_REPO: your-org/online-boutique-gitops
  DOCKER_REPO_PREFIX: ${{ secrets.DOCKERHUB_USERNAME }} # Use GitHub Secrets for repository prefix
  

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history for CalVer build count
      
      - name: Set environment and version
        id: env
        run: |
          set -euo pipefail
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          if [ "${{ github.ref_name }}" == "main" ]; then
            # Production: CalVer (YYYY.MM.BUILD)
            DATE=$(date +%Y.%m)
            BUILD=$(git rev-list --count --since="$(date +%Y-%m-01)" HEAD)
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "version=v${DATE}.${BUILD}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" == "staging" ]; then
            # Staging: staging-SHA
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "version=staging-${SHORT_SHA}" >> $GITHUB_OUTPUT
          else
            # Development: dev-SHA
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "version=dev-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi
      
      - name: Show deployment info
        run: |
          echo "üöÄ Service: ${{ vars.MS_NAME }}"
          echo "üåç Environment: ${{ steps.env.outputs.environment }}"
          echo "üì¶ Version: ${{ steps.env.outputs.version }}"
          echo "üìù Commit: ${{ github.sha }}"
      
      - name: Set up QEMU for Multi-Architecture Builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image with Caching
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true 
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ${{ env.DOCKER_REPO_PREFIX }}/${{ vars.MS_NAME }}:latest
            ${{ env.DOCKER_REPO_PREFIX }}/${{ vars.MS_NAME }}:${{ steps.env.outputs.version }}
      





